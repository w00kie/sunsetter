{
  "version": 3,
  "file": "tools.js",
  "sourceRoot": "../..",
  "sources": [
    "static/src/tools.coffee"
  ],
  "names": [],
  "mappings": "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",
  "sourcesContent": [
    "$ ->\n\t# Create map\n\t# If geolocated, set current position as center\n\tif google.loader.ClientLocation\n\t\tlatlng = new google.maps.LatLng google.loader.ClientLocation.latitude, google.loader.ClientLocation.longitude\n\telse\t# Else center in Tokyo\n\t\tlatlng = new google.maps.LatLng(35.41, 139.44)\n\n\t# Enable the visual refresh\n\tgoogle.maps.visualRefresh = true\n\n\tmyOptions =\n\t\tzoom: 9\n\t\tcenter: latlng\n\t\tmapTypeId: google.maps.MapTypeId.ROADMAP\n\n\tmap = new google.maps.Map document.getElementById(\"map_canvas\"), myOptions\n\n\t# Default marker position\n\tmarkerpos = new google.maps.LatLng 1, 1\n\n\t# Initialize POV and POI Markers as well as LOS Polyline\n\tpovmarker = new google.maps.Marker(\n\t\tposition: markerpos\n\t\tmap: map\n\t\ticon: '/static/img/man.png'\n\t\tdraggable: true\n\t\tvisible: false\n\t)\n\n\tpoimarker = new google.maps.Marker(\n\t\tposition: markerpos\n\t\tmap: map\n\t\tdraggable: true\n\t\tvisible: false\n\t)\n\n\tlos = new google.maps.Polyline(\n\t\tpath: [\n\t\t\tpovmarker.getPosition()\n\t\t\tpoimarker.getPosition()\n\t\t]\n\t\tstrokeColor: \"#FF0000\"\n\t\tstrokeOpacity: 0\n\t\tstrokeWeight: 6\n\t)\n\n\tlos.setMap map\n\n\t# Click on the map event - works only 2 first times\n\tgoogle.maps.event.addListener map, 'click', (event) =>\n\t\t# First click, show POV marker\n\t\tif not povmarker.getVisible()\n\t\t\tpovmarker.setPosition event.latLng\n\t\t\tpovmarker.setVisible true\n\t\t\t#queryEphemerides povmarker\n\t\t\t$(\"#step1\").removeClass(\"active\", 500)\n\t\t\t$(\"#step2\").addClass(\"active\", 500)\n\t\t# Second click, show POI marker\n\t\telse if not poimarker.getVisible()\n\t\t\tpoimarker.setPosition event.latLng\n\t\t\tpoimarker.setVisible true\n\t\t\tlos.setOptions {strokeOpacity: 0.6}\n\t\t\t$(\"#azimuth\").show()\n\t\t\tqueryMatch povmarker, poimarker\n\t\t\t$(\"#step2\").removeClass(\"active\", 500)\n\t\t\t$(\"#step3\").addClass(\"active\", 500)\n\n\t# Move markers event\n\t$([povmarker, poimarker]).each (i,marker) =>\n\t\tgoogle.maps.event.addListener marker, 'position_changed', () =>\n\t\t\tlos.setPath [povmarker.getPosition(), poimarker.getPosition()]\n\t\t\tdocument.az = getAzimuth povmarker.getPosition(), poimarker.getPosition()\n\t\t\t$(\"#azimuth\").text document.az.round(2)+\"ยบ\"\n\t\t\t# Clear results\n\t\t\t$(\"#results\").html(\"\")\n\n\t# Query for a match on drop\n\t$([povmarker, poimarker]).each (i,marker) =>\n\t\tgoogle.maps.event.addListener marker, 'dragend', () =>\n\t\t\t#queryEphemerides(povmarker)\n\t\t\tqueryMatch povmarker, poimarker\n\n\t# Reset button action\n\t$(\"#reset\").click () ->\n\t\tpovmarker.setOptions {position: markerpos, visible: false}\n\t\tpoimarker.setOptions {position: markerpos, visible: false}\n\t\tlos.setOptions {strokeOpacity: 0}\n\t\t$(\"#step1\").addClass(\"active\", 500)\n\t\t$(\"#step2\").removeClass(\"active\", 500)\n\t\t$(\"#step3\").removeClass(\"active\", 500)\n\t\t$(\"#azimuth\").hide()\n\t\t$(\"#results\").html(\"\")\n\t\twindow.location.hash = \"\"\n\n\t# Setup map if vars passed in URL hash\n\thash = getHash()\n\tif \"pov\" in Object.keys(hash) and \"poi\" in Object.keys(hash)\n\t\t# Parse locations from URL\n\t\tpovpos = strToLatLng hash.pov\n\t\tpoipos = strToLatLng hash.poi\n\t\t# Move markers to locations\n\t\tpovmarker.setPosition povpos\n\t\tpoimarker.setPosition poipos\n\t\t# Make elements visible\n\t\tpovmarker.setVisible true\n\t\tpoimarker.setVisible true\n\t\tlos.setOptions {strokeOpacity: 0.6}\n\t\t# Zoom map to fit both markers\n\t\tbounds = new google.maps.LatLngBounds()\n\t\tbounds.extend povpos\n\t\tbounds.extend poipos\n\t\t#map.panTo bounds.getCenter()\n\t\tmap.fitBounds bounds\n\t\t# Increment instruction steps\n\t\t$(\"#step1\").removeClass(\"active\", 500)\n\t\t$(\"#step3\").addClass(\"active\", 500)\n\t\t$(\"#azimuth\").show()\n\t\t# Finally call the backend\n\t\tqueryMatch povmarker, poimarker\n\telse\n\t\t# Try HTML5 geolocation\n\t\t# Do it only if no location in URL as asynchronous geoloc messes with fitBounds\n\t\tif navigator.geolocation\n\t\t\tnavigator.geolocation.getCurrentPosition (position) =>\n\t\t\t\tlatlng = new google.maps.LatLng position.coords.latitude, position.coords.longitude\n\t\t\t\tmap.panTo latlng\n\n\ngetAzimuth = (pov, poi) ->\n\tpovLat = pov.lat().toRad()\n\tpoiLat = poi.lat().toRad()\n\tdLon = (poi.lng() - pov.lng()).toRad()\n\ty = Math.sin(dLon) * Math.cos(poiLat)\n\tx = Math.cos(povLat) * Math.sin(poiLat) - Math.sin(povLat) * Math.cos(poiLat) * Math.cos(dLon)\n\treturn Math.atan2(y, x).toBrng()\n\n# Sets the marker positions in the URL\nsetHash = (pov, poi) ->\n\tpovpos = pov.getPosition().toUrlValue()\n\tpoipos = poi.getPosition().toUrlValue()\n\twindow.location.hash = \"pov=#{povpos}&poi=#{poipos}\"\n\n# Decode parameters from hash\n# shamelessly stolen from http://papermashup.com/read-url-get-variables-withjavascript/\ngetHash = () ->\n\tvars = {}\n\twindow.location.hash.replace /[#&]+([^=&]+)=([^&]*)/gi, (m, key, value) =>\n\t\tvars[key] = value\n\treturn vars\n\n# Make a Google Maps LatLng object from a string\nstrToLatLng = (str) ->\n\tcoord = str.split(\",\")\n\tnew google.maps.LatLng coord[0], coord[1]\n\n# NOT USED\nqueryEphemerides = (pov) ->\n\tpovlat = pov.getPosition().lat().round(1)\n\t$.ajax(\n\t\ttype: \"POST\"\n\t\turl: \"/GetEphemerides\"\n\t\tdata: {lat: povlat}\n\t\tdataType: \"json\"\n\t\tsuccess: (reply) =>\n\t\t\tdocument.ephemerides = reply\n\t)\n\nqueryMatch = (pov, poi) ->\n\t# Set the spinner\n\tdocument.spinner = new Spinner(\n\t\tlines: 13 # The number of lines to draw\n\t\tlength: 7 # The length of each line\n\t\twidth: 4 # The line thickness\n\t\tradius: 10 # The radius of the inner circle\n\t\trotate: 0 # The rotation offset\n\t\tcolor: '#333' # #rgb or #rrggbb\n\t\tspeed: 1 # Rounds per second\n\t\ttrail: 60 # Afterglow percentage\n\t\tshadow: false # Whether to render a shadow\n\t\thwaccel: true # Whether to use hardware acceleration\n\t\tclassName: 'spinner' # The CSS class to assign to the spinner\n\t\tzIndex: 2e9 # The z-index (defaults to 2000000000)\n\t\ttop: 'auto' # Top position relative to parent in px\n\t\tleft: 'auto' # Left position relative to parent in px\n\t).spin($(\"#results\")[0])\n\n\t# Log a request to Google Analytics\n\t_gaq.push ['_trackEvent', 'Interaction', 'Request']\n\n\tpovlat = pov.getPosition().lat().round(1)\n\t$.ajax(\n\t\ttype: \"POST\"\n\t\turl: \"/findMatch\"\n\t\tdata: {lat: povlat, az: document.az}\n\t\tdataType: \"json\"\n\t\tsuccess: (reply) =>\n\t\t\tif reply.matches?\n\t\t\t\t# Create HTML for the result days list\n\t\t\t\tdaylist = $(\"<ul>\").addClass(\"matches\")\n\t\t\t\tdaylist.append($(\"<li>\").text(day)) for day in reply.matches\n\t\t\t\t# Write the type (sunrise or sunset) and results to the screen\n\t\t\t\t$(\"#results\").text(\"#{reply.suntype} on:\").append(daylist)\n\t\t\t\t# Log the result to Google Analytics\n\t\t\t\t_gaq.push ['_trackEvent', 'Interaction', 'Success', reply.suntype]\n\t\t\telse\n\t\t\t\t$(\"#results\").text(\"Sorry, there is no #{reply.suntype} in this direction.\")\n\t\t\t\t# Log the result to Google Analytics\n\t\t\t\t_gaq.push ['_trackEvent', 'Interaction', 'Success', 'Out of Bounds']\n\t\terror: () =>\n\t\t\t$(\"#results\").text(\"ERROR in the Request.\")\n\t\t\t# Log the error to Google Analytics\n\t\t\t_gaq.push ['_trackEvent', 'Interaction', 'Error']\n\t\tcomplete: () =>\n\t\t\tdocument.spinner.stop()\n\t\t\tsetHash pov, poi\n\t)\n\n# extend Number object with methods for converting degrees/radians\nNumber::toRad = () ->  # convert degrees to radians\n\treturn this * Math.PI / 180\n\nNumber::toDeg = () ->  # convert radians to degrees (signed)\n\treturn this * 180 / Math.PI\n\nNumber::toBrng = () ->  # convert radians to degrees (as bearing: 0...360)\n\treturn (this.toDeg()+360) % 360\n\nNumber::round = (decimals) ->\n\treturn Math.round(this * Math.pow(10, decimals)) / Math.pow(10, decimals)\n"
  ]
}